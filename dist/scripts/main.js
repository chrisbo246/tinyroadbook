"use strict";window.numberToName=function(e,t,o,n,a){a=a||Math.ceil(n.length/2);var r=(o-t)/n.length,l=(e-t)/r;l=Math.min(Math.max(l.toFixed(0),0),n.length-1);var i=n[l]||n[a];return console.log("numberToFontSize("+e+", "+t+", "+o+") step: "+r+" i: "+l+" name: "+i),i},window.formatBytes=function(e,t){if(0===e)return"0 Byte";var o=1e3,n=t+1||3,a=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"],r=Math.floor(Math.log(e)/Math.log(o));return(e/Math.pow(o,r)).toPrecision(n)+" "+a[r]},window.escapeHtml=function(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return String(e).replace(/[&<>"'\/]/g,function(e){return t[e]})},$.urlParam=function(e){var t=new RegExp("[?&]"+e+"=([^&#]*)").exec(window.location.href);return null===t?null:t[1]||0};var commonsModule=function(){var e={basil:{},debug:{debugMode:!!parseInt($.urlParam("debug")),disabledLogs:["log","time","timeEnd"]},adsense:{containers:".adsbygoogle",adClient:"ca-pub-8495719252049968",adSlot:"3723415549",adFormat:"auto"},garlic:{fieldsSelector:".garlic-auto-save",formsSelector:'[data-persist="garlic"]'},parsley:{fieldsSelector:"[data-parsley-id]",formsSelector:"[data-parsley-validate]"},webFontLoader:{version:"1.6.16",config:{google:{families:["Material+Icons"]}}},materialDesign:{iconsSelector:".material-icons"},parallax:{selector:'[data-type="background"]'},scrollTo:{toggleSelector:".scroll"},mixitup:{selector:"#disabled_priorities, #faq_list"},i18next:{instance:null},input:{events:"input change click"},chosen:{events:"chosen:updated chosen:maxselected"},bootstrapSwitch:{events:" switchChange.bootstrapSwitch"},sortable:{events:"sortactivate sortbeforeStop sortchange sortcreate sortdeactivate sortout sortover sortreceive sortremove sort sortstart sortstop sortupdate"},reset:{formsSelector:"form",toggleSelector:"#reset_all",defaultAttribut:"default-value"},swal:{resetWarning:{title:"Reset everything?",text:"This will erase your roadbook, reset settings and delete all local data stored by this application.",type:"warning",confirmButtonText:"Yes reset",cancelButtonText:"No stop !",showCancelButton:!0,closeOnConfirm:!1}}};if("function"==typeof Basil)var t=new window.Basil(e.basil);var o=function(t){t=t||"body";var o,n=$(t).find(e.adsense.containers).filter(":not([data-adsbygoogle-status])");console.log(n.length+" uninitialized ad(s) found in "+t),n.each(function(t,n){o=$(n),0===o.parents(":not(:visible)").length?(o.attr("data-ad-client")||o.attr("data-ad-client",e.adsense.adClient),o.attr("data-ad-slot")||o.attr("data-ad-slot",e.adsense.adSlot),o.attr("data-ad-format")||o.attr("data-ad-format",e.adsense.adFormat),console.log("Adsense attributs added to","#"+o.attr("id")),(adsbygoogle=window.adsbygoogle||[]).push({}),console.log("#"+o.attr("id")+" ad initialised with attributs ",o.data())):console.log("#"+o.attr("id")+" ad is in a hidden container and cannot be initialized now")})},n=function(){$.getScript("//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js",function(){console.log("Google Adsense library loaded"),$("html").addClass("adsbygoogle-status-done")})},a=function(){$(function(){var t=$(window);$(e.parallax.selector).each(function(){var e=$(this);t.scroll(function(){var o=-(t.scrollTop()/e.data("speed")),n="50% "+o+"px";e.css({backgroundPosition:n})})})})},r=function(t){$.extend(!0,e.scrollTo,t),$(function(){$(e.scrollTo.toggleSelector).click(function(){return $.scrollTo(this.hash,1500,{easing:"swing"}),!1})})},l=function(){if(document.cookie){var o=document.cookie.split(";");o.forEach(function(e){document.cookie=e.split("=")[0]+"=; username=; expires=Thu, 01 Jan 1970 00:00:00 UTC"})}localStorage&&localStorage.clear(),$().garlic&&$(e.garlic.fieldsSelector).garlic("destroy"),t&&t.reset()},i=function(e,o){var n=location.hash;return!o&&t&&(n=t.get(e)),n},s=function(e,o,n){!n&&t?t.set(e,o):location.hash=o},c=function(){if(!t)return!1;var o,n,a,r;$(e.garlic.formsSelector).each(function(){o=$(this),o.find(":input").not(":file").not(":button").not('[type="submit"]').not('[type="reset"]').filter("[id]").each(function(){n=$(this),r=n.attr("id"),a=t.get(r),null!==a&&("checkbox"===n.attr("type")||"radio"===n.attr("type")?n.prop("checked",a):n.val(a),console.log("#"+r+" value restored",a)),n.on("change",function(){n=$(this),a="checkbox"===n.attr("type")||"radio"===n.attr("type")?n.prop("checked"):n.val(),r=n.attr("id"),t.set(r,a),console.log("#"+r+" value stored",a)})})})},u=function(t){if(!e.reset.defaultAttribut)return!1;t||(t=e.reset.formsSelector);var o,n,a;$(t).find(":input").not(":file").not(":button").not('[type="submit"]').not('[type="reset"]').each(function(){o=$(this),a=o.attr("type"),n="checkbox"===a||"radio"===a?o.prop("checked"):o.val(),o.attr("data-"+e.reset.defaultAttribut,n)})},d=function(o){var n,a,r,l;return e.reset.defaultAttribut?(o||(o=e.reset.formsSelector),void $(o).find(":input").filter("[data-"+e.reset.defaultAttribut+"]").each(function(){n=$(this),a=n.attr("id"),r=n.attr("type"),l=n.data(e.reset.defaultAttribut),a&&("checkbox"===r||"radio"===r?n.prop("checked",l):n.val(l),t&&t.remove(a))})):!1},m=function(){$(function(){$(e.reset.toggleSelector).click(function(){swal?swal(e.swal.resetWarning,function(e){e&&(l(),location.reload())}):(l(),location.reload())})})},p=function(t){$.extend(!0,e.googleFonts,t),window.WebFontConfig={},$.extend(!0,window.WebFontConfig,e.webFontLoader.config),function(t){var o=t.createElement("script"),n=t.scripts[0];o.src="https://ajax.googleapis.com/ajax/libs/webfont/"+e.webFontLoader.version+"/webfont.js",n.parentNode.insertBefore(o,n)}(document)},g=function(){if(!e.debug.debugMode)return console.log=function(){},console.time=function(){},console.timeEnd=function(){},e.debug.disabledLogs.forEach(function(e){console[e]=function(){}}),$(".debug-only").hide(),!1;if($(".debug-only").show(),console.log("Debug mode",e.debug.debugMode),e.input.events){var t=e.input.events;$().chosen&&(t+=e.chosen.events),$().bootstrapSwitch&&(t+=e.bootstrapSwitch.events),$(":input").on(t,function(e){var t=$(this),o=[];o.push('"'+e.type+'" event fired on "'+t.prop("tagName")+'" element'),t.attr("type")&&o.push('[type="'+t.attr("type")+'"]'),t.attr("id")&&o.push('[id="'+t.attr("id")+'"]'),t.attr("name")&&o.push('[name="'+t.attr("name")+'"]'),"input"!==e.type&&"change"!==e.type||(o.push('value="'+t.val()+'"'),"checkbox"!==t.attr("type")&&"radio"!==t.attr("type")||o.push('checked="'+this.checked+'"')),console.log(o.join(" "))})}console.time("jQuery is ready"),console.time("HTML is loaded and DOM is ready"),console.time("Images, frames and objects are loaded"),$(function(){console.timeEnd("jQuery is ready")}),$(document).ready(function(){console.timeEnd("HTML is loaded and DOM is ready")}),$(window).on("load",function(){console.timeEnd("Images, frames and objects are loaded")}),console.log("location.hostname",location.hostname),console.log("document.location.hostname",document.location.hostname),console.log("window.location.hostname",window.location.hostname),console.log("document.domain",document.domain),console.log("document.URL",document.URL),console.log("document.location.href",document.location.href),console.log("document.location.origin",document.location.origin),console.log("document.location.host",document.location.host),console.log("document.location.pathname",document.location.pathname),console.log("navigator.language",navigator.language),console.log("navigator.userLanguage",navigator.userLanguage),$().sortable&&e.sortable.events&&$(".ui-sortable").on(e.sortable.events,function(e){console.log("#"+$(this).attr("id")+" event "+e.type+"("+$(this).sortable("toArray").length+")")}),$().mixitup&&e.mixitup.selector&&$(e.mixitup.selector).on("mixLoad mixStart mixEnd mixFail mixBusy",function(e,t){console.log("mixItUp "+e.type+": "+t.totalShow+" elements match the current filter")}),$().garlic&&e.garlic.fieldsSelector&&$(e.garlic.selector).garlic({onRetrieve:function(e,t){console.log("Garlic retrieved for "+(e.attr("id")?'id="#'+e.attr("id")+'"':"")+" "+(e.attr("name")?'name="#'+e.attr("name")+'"':""),t)},onPersist:function(e,t){console.log("Garlic persisted value for "+(e.attr("id")?'id="#'+e.attr("id")+'"':"")+" "+(e.attr("name")?'name="#'+e.attr("name")+'"':""),t)}}),$().parsley&&$.each(["form:init","form:validate","form:success","form:error","form:validated","form:submit","field:init","field:validate","field:success","field:error","field:validated"],function(e,t){window.Parsley.on(t,function(){console.log("Parsley "+t,"#"+this.$element.attr("id"))})}),"function"==typeof i18next&&e.i18next.instance&&(e.i18next.instance.useLocalStorage=!1,e.i18next.instance.localStorageExpirationTime=0,e.i18next.instance.on("initialized",function(){console.log("i18next initialized")}).on("loaded",function(){console.log("i18next loaded")}).on("failedLoading",function(e,t,o){console.warn("i18next failed loading: "+o+" language: "+e+" ns: "+t)}))},f=function(e,t,o){if(!(window.File&&window.FileReader&&window.FileList&&window.Blob))return!1;var n=new $.Deferred,a=0;return o=$.extend(!0,{},{format:"text",encoding:"UTF-8",cancelSelector:null},o),$.each(e,function(r,l){var i=new FileReader;"buffer"===o.format?i.readAsArrayBuffer(l,o.encoding):"binary"===o.format?i.readAsBinaryString(l,o.encoding):"data"===o.format?i.readAsDataURL(l,o.encoding):i.readAsText(l,o.encoding),i.onload=function(e){console.log("File load",e),t(e.target.result)},i.onloadstart=function(){},i.onloadend=function(){console.log(r+1+"/"+e.length+" file loaded"),a+=1,a===e.length&&(console.log("Last file loaded"),n.resolve())},i.onerror=function(){swal({title:"Oups!",text:"An error occured while trying to read your file.",type:"warning"})},o.cancelSelector&&$(o.cancelSelector).on("click",function(){i.abort()})}),n},h=function(){window.File&&window.FileReader&&window.FileList&&window.Blob||($('input[type="file"]').addClass("disabled"),console.warn("The File APIs are not fully supported by your browser."))},y=function(){var e=location.hash.replace("#","");""!==e&&(location.hash="")},w=function(e){var t,o=$(e||"body");o&&o.find('a[href^="#"]').each(function(e,o){t=$(this),console.log("Watching internal links clicks",$(o).attr("href")),t.on("click",function(e){y(),console.log("URL hash hidden",e.currentTarget.hash)})})},b=function(){g(),p(),n(),u(),c(),h(),a(),m()};return{init:b,adsense:n,insertAdsenseAds:o,basil:t,debug:g,disableUnsupported:h,loadWebFonts:p,parallax:a,storeForms:c,reader:f,resetButton:m,scrollTo:r,storeHash:s,hideHash:y,hideHashOnClick:w,restoreHash:i,fixInputValues:u,resetInputValues:d}}(),bootstrapModule=function(){var e={basil:{namespace:"bootstrap"},modal:{modalSelector:".modal",toggleSelector:'[data-toggle="modal"]',storeActive:!1},tab:{toggleSelector:'[data-toggle="tab"]',storeActive:!0,useHash:!1},tooltip:{toggleSelector:'[data-toggle="tooltip"]',options:{}}},t=function(){if("undefined"!=typeof Basil&&"undefined"!=typeof $.fn.tab){var t,o=new window.Basil(e.basil),n=$(e.tab.toggleSelector),a="activeTab";if(n){if(!e.tab.useHash&&o?(t=o.get(a),console.log("Hash restored",t)):(t=location.hash,console.log("URL hash detected",t)),t){var r=n.filter('[href="'+t+'"]').first();r.tab("show"),console.log("Last active tab restored",t)}n.on("shown.bs.tab",function(n){t=n.target.hash,t&&(!e.tab.useHash&&o?(o.set(a,t),console.log("Active tab stored",t)):(location.hash=t,console.log("Active tab hash added to URL",t)))})}}else console.warn("Bootstrap tab plugin is not loaded")},o=function(){if(!$().tab)return!1;var t=$(e.tab.toggleSelector);t&&(t.on("click",function(){$(".dropdown-menu").find(".active").removeClass("active")}),e.storeActive)},n=function(){if("undefined"!=typeof Basil&&"undefined"!=typeof $.fn.modal){var t=new window.Basil(e.basil),o=$(e.modal.modalSelector),n="activeModal",a=t.get(n);if(o){if(a){var r=$(a);r.modal("show"),console.log("Last active modal restored",a)}o.on("shown.bs.modal",function(e){a="#"+e.target.id,a&&(t.set(n,a),console.log("Active modal stored",a))}),o.on("hidden.bs.modal",function(){t.set(n,null),console.log("Active modal stored",null)})}}else console.warn("Bootstrap modal plugin is not loaded")},a=function(){return $().modal?void $(e.modal.modalSelector).on("show.bs.modal",function(e){var t,o=$(this),n=$(e.relatedTarget),a=n.data();if(a){if(a.targetSection){var r=o.find("[data-section]");console.log("Targeted section",a.targetSection);var l;r&&r.each(function(){l=$(this),l.data("section")===a.targetSection?(l.show(),console.log("Show section",l.data("section"))):(l.hide(),console.log("Hide section",l.data("section")))})}a.title&&(t=o.find(".modal-title").first(),t&&t.text(a.title)),a.ok&&(t=o.find(".modal-footer .btn-primary").first(),t&&t.text(a.ok)),a.ok&&(t=o.find('.modal-footer [data-dismiss="modal"]').first(),t&&t.text(a.ok))}}):!1},r=function(e,t){var o=$(t);if(!o||!e)return!1;var n=[];$.each(e,function(e,t){n.push('<li class="list-group-item">'+escape(t.name)+' <span class="badge">'+formatBytes(t.size)+(" "+t.type||"")+"<span></li>")}),o.html('<ul class="list-group">'+n.join("")+"</ul>")},l=function(t,o){var n=$(t);return n?void n.find(e.tab.toggleSelector).one("shown.bs.tab",function(e){var t=$(e.target).attr("href");o(t)}):!1},i=function(){var e=$('input[type="range"]');e&&(e.attr("data-original-title",e.val()),e.on("input",function(){e.attr("data-original-title",e.val()).tooltip("show")}),e.on("focus",function(){e.tooltip("show")}))},s=function(){$().tooltip&&$(e.tooltip.toggleSelector).tooltip(e.tooltip.options)},c=function(){if($().tab){var t=$(e.tab.toggleSelector);t.on("shown.bs.tab",function(e){var t=$(e.target).attr("href");console.log("Tab shown",t)})}if($().modal){var o=$(e.modal.modalSelector);o.on("shown.bs.modal",function(e){var t="#"+e.target.id;console.log("Modal shown",t)})}},u=function(){if($().tab){var t=$(e.tab.toggleSelector);t.on("shown.bs.tab",function(){commonsModule.hideHash()})}if($().modal){var o=$(e.modal.modalSelector);o.on("shown.bs.modal",function(){commonsModule.hideHash()})}};return $(function(){}),{debug:c,inputFileList:r,modalTogglerAttributs:a,tab:o,oneShownHiddenTab:l,rangeValueTooltip:i,settings:e,restoreActiveTab:t,restoreActiveModal:n,tooltip:s,hideHashOnShown:u}}(),MapModule=function(e,t){var o={ol:{},basil:{}};t=$.extend(!0,{},o,t);var n;n||"undefined"==typeof window.Basil||(t.basil.namespace||(t.basil.namespace=e.get("target")),n=new window.Basil(t.basil));var a=function(){if(!n)return!1;var t=e.getView();t.on("change:center",function(){n.set("center",this.getCenter())}),t.on("change:resolution",function(){n.set("zoom",this.getZoom())}),e.on("moveend",function(){n.set("center",t.getCenter())}),e.on("postrender",function(){n.set("zoom",t.getZoom())})},r=function(){if(!n)return!1;var t=!1,o=e.getView();return n.get("center")&&(o.setCenter(n.get("center")),t=!0),n.get("zoom")&&(o.setZoom(n.get("zoom")),t=!0),t},l=function(){var t=e.get("target"),o=e.getView();e.on("change change:layerGroup change:size change:target change:view click dblclick moveend pointerdrag pointermove postcompose postrender precompose propertychange singleclick",function(e){console.log(t+" map ",e),console.log(t+" map "+e.name+" event firered",e.value)}),o.on("change change:center change:resolution change:rotation propertychange",function(e){console.log(t+" map view ",e),console.log(t+" map view "+e.name+" event firered",e.value)})},i=function(){var t=e.getLayers();$.each(t,function(e,t){t.getVisible()?console.log("Selected layer",t.get("name")):console.log("Unselected layer",t.get("name")),t.on("change:visible",function(){this.getVisible()&&console.log("Selected layer",this.get("name"))})})},s=function(t,o){var n=e.getView();n.setCenter(ol.proj.transform([t,o],"EPSG:4326","EPSG:3857")),console.log("Map centered at longitude: "+t+" latitude: "+o)},c=function(){var t=e.getView(),o=new ol.Geolocation({projection:t.getProjection(),tracking:!0});o.once("change:position",function(){t.setCenter(o.getPosition())})},u=function(t){t=parseInt(t),t&&e.getView().setZoom(t)},d=function(){var t=e.getView(),o=t.getExtent();t.fit(o,e.getSize())},m=function(){var t=e.getView(),o=ol.extent.createEmpty();e.getLayers().forEach(function(e){ol.extent.extend(o,e.getSource().getExtent())}),t.fit(o,e.getSize())},p=function(t){var o=e.getView(),n=t.getSource().getExtent();o.fit(n,e.getSize())},g=function(t,o,n){var a=o.getSource(),r=a.getFeatureById(t),l=r.getGeometry(),i=e.getSize(),s=e.getView();s.fit(l,i,$.extend({padding:[0,0,0,0],constrainResolution:!1},n))};return{settings:t,map:e,basil:n,debug:l,setZoom:u,setCenter:s,setCenterOnPosition:c,getSelectedBaseLayer:i,storeMapState:a,restoreMapState:r,fitView:d,fitLayers:m,fitVectorLayer:p,fitLayerGeometry:g}},mapLayersModule=function(){var e={bingMapsKey:"Ak-dzM4wZjSqTlzveKz5u0d4IQ4bRzVI309GxmkgSVr1ewS6iPSrOvOKhA-CJlm3",properties:{visible:!1,preload:"Infinity"}},t={},o=function(o,n){if(!t[o])return console.warn(o+" layer definition is not defined"),!1;var a=t[o]();return a.setProperties(e.properties),n&&a.setProperties(n),a},n=function s(e,o){$.each(t,function(e,t){t.getLayers()?s(t,o):o(t)})},a=function(e,t){var o=$(t);if(o&&e){var n=$.trim(o.val());n&&e.setProperties({source:new ol.source.OSM({url:n})}),o.on("change",function(){n=$.trim(o.val()),n?e.setProperties({visible:!0,source:new ol.source.OSM({url:n})}):e.setProperties({visible:!1})})}},r=function(e){var t=0,o=e.get("name"),n=o.match(/([\-+]\d{2}):(\d{2})$/);if(n){var a=parseInt(n[1],10),r=parseInt(n[2],10);t=60*a+r}var l=new Date,i=new Date(l.getTime()+6e4*(l.getTimezoneOffset()+t)),s=Math.abs(12-i.getHours()+i.getMinutes()/60);s>12&&(s=24-s);var c=.75*(1-s/12);return[new ol.style.Style({fill:new ol.style.Fill({color:[85,85,85,c]}),stroke:new ol.style.Stroke({color:"#ffffff"})})]};t.openStreetMap=function(){return new ol.layer.Tile({name:"openStreetMap",title:'Road Map<small> (by <a href="http://www.openstreetmap.org">OpenStreetMap</a>)</small>',visible:!0,type:"base",source:new ol.source.OSM({urls:["http://a.tile.openstreetmap.org/{z}/{x}/{y}.png"]})})},t.openSeaMap=function(){return new ol.layer.Tile({name:"openSeaMap",title:'Shipping lanes<small> (by <a href="http://www.openseamap.org">OpenSeaMap</a>)</small>',type:"base",source:new ol.source.OSM({attributions:[new ol.Attribution({html:'All maps &copy; <a href="http://www.openseamap.org/">OpenSeaMap</a>'}),ol.source.OSM.ATTRIBUTION],crossOrigin:null,urls:["http://tiles.openseamap.org/seamark/{z}/{x}/{y}.png","http://t1.openseamap.org/seamark/{z}/{x}/{y}.png"]})})},t.openStreetMapHumanitarian=function(){return new ol.layer.Tile({name:"openStreetMapHumanitarian",title:'Humanitarian <small>(by <a href="http://www.openstreetmap.org">OpenStreetMap</a>)</small>',type:"base",source:new ol.source.OSM({attributions:[new ol.Attribution({html:'All maps &copy; <a href="http://www.openstreetmap.fr/">OpenStreetMap</a>'}),ol.source.OSM.ATTRIBUTION],url:"http://tile-{a-c}.openstreetmap.fr/hot/{z}/{x}/{y}.png"})})},t.mapquestOSM=function(){return new ol.layer.Tile({name:"mapquestOSM",title:'Road map<small> (by <a href="http://open.mapquest.com">MapQuest</a>)</small>',type:"base",source:new ol.source.MapQuest({layer:"osm"})})},t.mapquestSat=function(){return new ol.layer.Tile({name:"mapquestSat",title:'Aerial view<small> (by <a href="http://open.mapquest.com">MapQuest</a>)</small>',type:"base",source:new ol.source.MapQuest({layer:"sat"})})},t.openCycleMap=function(){return new ol.layer.Tile({name:"openCycleMap",title:'Cycling roads<small> (by <a href="http://www.opencyclemap.org">OpenCycleMap</a>)</small>',type:"base",source:new ol.source.OSM({attributions:[new ol.Attribution({html:'All maps &copy; <a href="http://www.opencyclemap.org/">OpenCycleMap</a>'}),ol.source.OSM.ATTRIBUTION],url:"http://{a-c}.tile.opencyclemap.org/cycle/{z}/{x}/{y}.png"})})},t.thunderforestTransport=function(){return new ol.layer.Tile({name:"thunderforestTransport",title:'Transports<small> (by <a href="http://www.thunderforest.com">ThunderForest</a>)</small>',type:"base",source:new ol.source.OSM({attributions:[new ol.Attribution({html:'All maps &copy; <a href="http://www.thunderforest.com/">ThunderForest</a>'}),ol.source.OSM.ATTRIBUTION],url:"http://{a-c}.tile.thunderforest.com/transport/{z}/{x}/{y}.png"})})},t.thunderforestTransportDark=function(){return new ol.layer.Tile({name:"thunderforestTransportDark",title:'Transport dark<small> (by <a href="http://www.thunderforest.com">ThunderForest</a>)</small>',type:"base",source:new ol.source.OSM({attributions:[new ol.Attribution({html:'All maps &copy; <a href="http://www.thunderforest.com/">ThunderForest</a>'}),ol.source.OSM.ATTRIBUTION],url:"https://{a-c}.tile.thunderforest.com/transport-dark/{z}/{x}/{y}.png"})})},t.thunderforestLandscape=function(){return new ol.layer.Tile({name:"thunderforestLandscape",title:'Landscape<small> (by <a href="http://www.thunderforest.com">ThunderForest</a>)</small>',type:"base",source:new ol.source.OSM({attributions:[new ol.Attribution({html:'All maps &copy; <a href="http://www.thunderforest.com/">ThunderForest</a>'}),ol.source.OSM.ATTRIBUTION],url:"https://{a-c}.tile.thunderforest.com/landscape/{z}/{x}/{y}.png"})})},t.thunderforestOutdoor=function(){return new ol.layer.Tile({name:"thunderforestOutdoor",title:'Outdoor activities<small> (by <a href="http://www.thunderforest.com">ThunderForest</a>)</small>',type:"base",source:new ol.source.OSM({attributions:[new ol.Attribution({html:'All maps &copy; <a href="http://www.thunderforest.com/">ThunderForest</a>'}),ol.source.OSM.ATTRIBUTION],url:"https://{a-c}.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png"})})},t.arcgis=function(){return new ol.layer.Tile({name:"arcgis",title:'Terrain<small> (by <a href="http://services.arcgisonline.com">ArcGIS</a>)</small>',type:"base",source:new ol.source.XYZ({crossOrigin:"anonymous",attributions:[new ol.Attribution({html:'Tiles &copy; <a href="http://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer">ArcGIS</a>'})],url:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}"})})},t.arcgisRestHighwayUSA=function(){return new ol.layer.Tile({name:"arcgisRestHighwayUSA",title:'Highway USA<small> (by <a href="http://services.arcgisonline.com">ArcGIS</a>)</small>',type:"base",extent:[-13884991,2870341,-7455066,6338219],source:new ol.source.TileArcGISRest({url:"http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Specialty/ESRI_StateCityHighway_USA/MapServer"})})},t.googleMap=function(){return new ol.layer.Tile({name:"googleMap",title:'Road map<small> (by <a href="http://www.google.com/maps/">Google</a>)</small>',type:"base",source:new ol.source.XYZ({crossOrigin:"anonymous",url:"http://mt1.google.com/vt/lyrs=m@285235804&hl=en&x={x}&y={y}&z={z}&s=1"})})},t.googleTerrain=function(){return new ol.layer.Tile({name:"googleTerrain",title:'Terrain + labels<small> (by <a href="http://www.google.com/maps/">Google</a>)</small>',type:"base",source:new ol.source.XYZ({crossOrigin:"anonymous",url:"http://mts1.google.com/vt/lyrs=t@132,r@285000000&hl=en&src=app&x={x}&y={y}&z={z}&s=1"})})},t.googleSatellite=function(){return new ol.layer.Tile({name:"googleSatellite",title:'Aerial view<small> (by <a href="http://www.google.com/maps/">Google</a>)</small>',type:"base",source:new ol.source.XYZ({crossOrigin:"anonymous",url:"https://www.google.se/maps/vt/pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m2!1e1!3i198!4e0"})})},t.bingRoad=function(){return new ol.layer.Tile({name:"bingRoad",title:'Road map<small> (by <a href="http://www.bing.com/maps/">Bing</a>)</small>',type:"base",maxZoom:19,source:new ol.source.BingMaps({key:e.bingMapsKey,imagerySet:"Road"})})},t.bingAerial=function(){return new ol.layer.Tile({name:"bingAerial",title:'Aerial view<small> (by <a href="http://www.bing.com/maps/">Bing</a>)</small>',type:"base",maxZoom:19,source:new ol.source.BingMaps({key:e.bingMapsKey,imagerySet:"Aerial"})})},t.bingAerialWithLabels=function(){return new ol.layer.Tile({name:"bingAerialWithLabels",title:'Aerial view with labels<small> (by <a href="http://www.bing.com/maps/">Bing</a>)</small>',type:"base",maxZoom:19,source:new ol.source.BingMaps({key:e.bingMapsKey,imagerySet:"AerialWithLabels"})})},t.bingCollinsBart=function(){return new ol.layer.Tile({name:"bingCollinsBart",title:'CollinsBart<small> (by <a href="http://www.bing.com/maps/">Bing</a>)</small>',type:"base",maxZoom:19,source:new ol.source.BingMaps({key:e.bingMapsKey,imagerySet:"collinsBart"})})},t.bingOrdnanceSurvey=function(){return new ol.layer.Tile({name:"bingOrdnanceSurvey",title:'OrdnanceSurvey<small> (by <a href="http://www.bing.com/maps/">Bing</a>)</small>',type:"base",maxZoom:19,source:new ol.source.BingMaps({key:e.bingMapsKey,imagerySet:"ordnanceSurvey"})})},t.stamenToner=function(){return new ol.layer.Tile({name:"stamenToner",title:'B&W map<small> (by <a href="http://maps.stamen.com">Stamen</a>)</small>',type:"base",source:new ol.source.Stamen({layer:"toner"})})},t.stamenTonerLite=function(){return new ol.layer.Tile({name:"stamenTonerLite",title:'Gray scale map<small> (by <a href="http://maps.stamen.com">Stamen</a>)</small>',type:"base",source:new ol.source.Stamen({layer:"toner-lite"})})},t.stamenTonerBackground=function(){return new ol.layer.Tile({name:"stamenTonerBackground",title:'B&W background<small> (by <a href="http://maps.stamen.com">Stamen</a>)</small>',type:"base",source:new ol.source.Stamen({layer:"toner-background"})})},t.stamenWatercolor=function(){return new ol.layer.Tile({name:"stamenWatercolor",title:'Watercolor map<small> (by <a href="http://maps.stamen.com">Stamen</a>)</small>',type:"base",source:new ol.source.Stamen({layer:"watercolor"})})},t.stamenTerrain=function(){return new ol.layer.Tile({name:"stamenTerrain",title:'Terrain USA<small> (by <a href="http://maps.stamen.com">Stamen</a>)</small>',type:"base",source:new ol.source.Stamen({layer:"terrain"})})},t.stamenTerrainWithLabels=function(){return new ol.layer.Tile({name:"stamenTerrainLabels",title:'Terrain + labels USA<small> (by <a href="http://maps.stamen.com">Stamen</a>)</small>',type:"base",source:new ol.source.Stamen({layer:"terrain-labels"})})},t.customBaseLayer=function(){return new ol.layer.Tile({name:"customBaseLayer",title:"Custom",type:"base"})},t.mapsForFreeRelief=function(){return new ol.layer.Tile({name:"mapsForFreeRelief",title:'Relief<small> (by <a href="http://www.maps-for-free.com">maps-for-free.com</a>)</small>',type:"base",maxZoom:11,source:new ol.source.XYZ({urls:["http://www.maps-for-free.com/layer/relief/z{z}/row{y}/{z}_{x}-{y}.jpg"]})})},t.googleBike=function(){return new ol.layer.Tile({name:"googleBike",title:'Cycling roads<small> (by <a href="http://www.google.com/maps/">Google</a>)</small>',visible:!0,opacity:1,source:new ol.source.XYZ({crossOrigin:"anonymous",url:"http://mts0.google.com/vt/lyrs=h@239000000,bike&hl=en&src=app&x={x}&y={y}&z={z}&s=1"})})},t.googleHybrid=function(){return new ol.layer.Tile({name:"googleHybrid",title:'Roads + labels<small> (by <a href="http://www.google.com/maps/">Google</a>)</small>',visible:!0,opacity:1,source:new ol.source.XYZ({crossOrigin:"anonymous",url:"http://mt1.google.com/vt/lyrs=h@239000000&hl=en&x={x}&y={y}&z={z}&s=1"})})},t.mapquestHyb=function(){return new ol.layer.Tile({name:"mapquestHyb",title:'City names<small> (by <a href="http://open.mapquest.com">MapQuest</a>)</small>',source:new ol.source.MapQuest({layer:"hyb"})})},t.lonviaCycling=function(){return new ol.layer.Tile({name:"lonviaCycling",title:'Cycling roads<small> (by <a href="http://www.waymarkedtrails.org">Lonvia</a>)</small>',opacity:.6,source:new ol.source.OSM({attributions:[new ol.Attribution({html:'Map data &copy; <a href="http://www.openstreetmap.org/">OpenStreetMap</a> and contributors <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'}),ol.source.OSM.ATTRIBUTION],crossOrigin:null,url:"http://tile.lonvia.de/cycling/{z}/{x}/{y}.png"})})},t.lonviaHiking=function(){return new ol.layer.Tile({name:"lonviaHiking",title:'Hiking paths<small> (by <a href="http://www.waymarkedtrails.org">Lonvia</a>)</small>',opacity:.6,source:new ol.source.OSM({attributions:[new ol.Attribution({html:'Map data &copy; <a href="http://www.openstreetmap.org/">OpenStreetMap</a> and contributors <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'}),ol.source.OSM.ATTRIBUTION],crossOrigin:null,url:"http://tile.lonvia.de/hiking/{z}/{x}/{y}.png"})})},t.stamenTonerHybrid=function(){return new ol.layer.Tile({name:"stamenTonerHybrid",title:'B&W roads + labels<small> (by <a href="http://maps.stamen.com">Stamen</a>)</small>',source:new ol.source.Stamen({layer:"toner-hybrid"})})},t.stamenTonerLabels=function(){return new ol.layer.Tile({name:"stamenTonerLabels",title:'B&W labels<small> (by <a href="http://maps.stamen.com">Stamen</a>)</small>',source:new ol.source.Stamen({layer:"toner-labels"})})},t.stamenTonerLines=function(){return new ol.layer.Tile({name:"stamenTonerLines",title:'B&W roads<small> (by <a href="http://maps.stamen.com">Stamen</a>)</small>',source:new ol.source.Stamen({layer:"toner-lines"})})},t.mapsForFreeWater=function(){return new ol.layer.Tile({name:"mapsForFreeWater",title:'Water<small> (by <a href="http://www.maps-for-free.com">maps-for-free.com</a>)</small>',opacity:.7,source:new ol.source.XYZ({url:"http://www.maps-for-free.com/layer/water/z{z}/row{y}/{z}_{x}-{y}.gif"})})},t.mapsForFreeAdmin=function(){return new ol.layer.Tile({name:"mapsForFreeAdmin",title:'Admin<small> (by <a href="http://www.maps-for-free.com">maps-for-free.com</a>)</small>',opacity:.3,source:new ol.source.XYZ({url:"http://www.maps-for-free.com/layer/admin/z{z}/row{y}/{z}_{x}-{y}.gif"})})};var l=function(){console.warm("ImageData function in development")},i=function(e,t){var o,n,a,r,i,s,c,u,d,m,p,g,f,h,y,w=e[0],b=w.width,v=w.height,S=w.data,M=new Uint8ClampedArray(S.length),T=2*t.resolution,x=b-1,$=v-1,k=[0,0,0,0],B=2*Math.PI,L=Math.PI/2,_=Math.PI*t.sunEl/180,C=Math.PI*t.sunAz/180,A=Math.cos(_),O=Math.sin(_);for(n=0;$>=n;++n)for(i=0===n?0:n-1,s=n===$?$:n+1,o=0;x>=o;++o)a=0===o?0:o-1,r=o===x?x:o+1,c=4*(n*b+a),k[0]=S[c],k[1]=S[c+1],k[2]=S[c+2],k[3]=S[c+3],u=t.vert*(k[0]+2*k[1]+3*k[2]),c=4*(n*b+r),k[0]=S[c],k[1]=S[c+1],k[2]=S[c+2],k[3]=S[c+3],d=t.vert*(k[0]+2*k[1]+3*k[2]),m=(d-u)/T,c=4*(i*b+o),k[0]=S[c],k[1]=S[c+1],k[2]=S[c+2],k[3]=S[c+3],u=t.vert*(k[0]+2*k[1]+3*k[2]),c=4*(s*b+o),k[0]=S[c],k[1]=S[c+1],k[2]=S[c+2],k[3]=S[c+3],d=t.vert*(k[0]+2*k[1]+3*k[2]),p=(d-u)/T,g=Math.atan(Math.sqrt(m*m+p*p)),f=Math.atan2(p,-m),f=0>f?L-f:f>L?B-f+L:L-f,h=O*Math.cos(g)+A*Math.sin(g)*Math.cos(C-f),c=4*(n*b+o),y=255*h,M[c]=y,M[c+1]=y,M[c+2]=y,M[c+3]=S[c+3];return new l(M,b,v)};return t.mapboxShadedRelief=function(){return new ol.layer.Image({name:"mapboxShadedRelief",title:'Shaded relief<small> (by <a href="http://www.mapbox.com">Mapbox</a>)</small>',source:new ol.source.Raster({sources:[new ol.source.XYZ({url:"https://{a-d}.tiles.mapbox.com/v3/aj.sf-dem/{z}/{x}/{y}.png",crossOrigin:"anonymous"})],operationType:"image",operation:i}),opacity:.3})},t.timeZones=function(){return new ol.layer.Vector({name:"timeZones",title:"Time zones",style:r,minResolution:4891,source:new ol.source.Vector({extractStyles:!1,projection:"EPSG:3857",url:"data/kml/timezones.kml",format:new ol.format.KML})})},t.gpxFile=function(){return new ol.layer.Vector({name:"gpxFile",title:"GPS tracks",visible:!1,source:new ol.source.Vector({}),style:new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(50, 255, 0, 0.6)",width:5})})})},t.drawingVector=function(){return new ol.layer.Tile({name:"drawing",title:"My drawings"})},t.customOverlay=function(){return new ol.layer.Tile({name:"customOverlay",title:"Custom"})},{create:o,inputLayerSource:a,treatLayers:n}}(),mapControlsModule=function(){var e={},t=function(t){if(!e[t])return console.warn(t+" control definition is not defined"),!1;var o=e[t]();return o};return e.attribution=function(){return new ol.control.Attribution({collapsible:!0})},e.zoomSlider=function(){return new ol.control.ZoomSlider({})},e.zoomToExtent=function(){return new ol.control.ZoomToExtent({});
},e.scaleLine=function(){return new ol.control.ScaleLine({})},e.fullScreen=function(){return new ol.control.FullScreen({})},e.overviewMap=function(){return new ol.control.OverviewMap({className:"ol-overviewmap ol-custom-overviewmap",collapseLabel:"«",label:"»",collapsed:!0})},e.layerSwitcher=function(){return new ol.control.LayerSwitcher({})},e.mousePosition=function(){return new ol.control.MousePosition({coordinateFormat:ol.coordinate.createStringXY(4),projection:"EPSG:4326",className:"custom-mouse-position",target:document.getElementById("mouse-position"),undefinedHTML:"&nbsp;"})},{create:t}}(),mapInputsModule=function(){var e,t={},o=function(e,o){if(!t[e])return console.warn(e+" input definition does not exists"),!1;var n=t[e](o);return n};return t.layer=function(t){var o=$(t);o&&(e.getLayers().forEach(function(e){e.get("visible")&&o.val(e.get("name"))}),o.on("change",function(){var t=o.find(":selected").val();e.getLayers().forEach(function(e){e.set("visible",e.get("name")===t)})}))},t.zoom=function(t){var o=$(t);o&&(o.val(this.getZoom()),o.on("change",function(){var t=o.val();(t||0===t)&&e.getView().setZoom(t)}),e.getView().on("change:resolution",function(){o.val(this.getZoom())}))},t.resolution=function(t){var o=$(t);o&&(o.val(this.getResolution()),o.on("change",function(){var t=o.val();(t||0===t)&&e.getView().setResolution(t)}),e.getView().on("change:resolution",function(){o.val(this.getResolution())}))},t.rotation=function(t){var o=$(t);o.on("change",function(){var t=o.val();(t||0===t)&&e.getView().setRotation(t)}),e.getView().on("change:rotation",function(){o.val(this.getRotation())})},t.centerX=function(t){var o=$(t);o.on("change",function(){o.val()}),e.getView().on("change:center",function(){var e=this.getCenter();o.val(e[0])})},t.centerY=function(t){var o=$(t);o.on("change",function(){o.val()}),e.getView().on("change:center",function(){var e=this.getCenter();o.val(e[1])})},t.center=function(t,o){var n=$(t),a=$(o);e.getView().on("change:center",function(){var e=this.getCenter();e&&(n.val(e[0].toFixed(2)),a.val(e[1].toFixed(2)))}),$(t+", "+o).on("change",function(){!n.val()&&0!==n.val()||!a.val()&&0!==a.val()||e.getView().setCenter(n.val(),a.val())})},t.exportPNG=function(){var t=document.getElementById("export-png");t&&t.on("click",function(){e.once("postcompose",function(e){var o=e.context.canvas;t.attr("href",o.toDataURL("image/png"))})})},t.GPXSource=function(e,t){window.File&&window.FileReader&&window.FileList&&window.Blob||console.warn("The File APIs are not fully supported in this browser.");var o=$(e);o.on("change",function(e){var o=e.target.files;o.forEach(function(e){var o=new FileReader;o.onload=function(e){return function(o){t.setProperties({title:escape(e.name),source:new ol.source.Vector({url:o.target.result,format:new ol.format.GPX}),visible:!0})}}(e),o.readAsDataURL(e)})})},{create:o}}(),mapDrawModule=function(){var e,t=new ol.Collection,o=new ol.interaction.Modify({features:t,deleteCondition:function(e){return ol.events.condition.shiftKeyOnly(e)&&ol.events.condition.singleClick(e)}}),n=new ol.layer.Vector({source:new ol.source.Vector({features:t}),style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})}),a=function(e){n.setMap(e),e.addInteraction(o)},r=function(o,n){o&&(e=new ol.interaction.Draw({features:t,type:o}),n.addInteraction(e))},l=function(t,o){var n=document.getElementById(t);n.onchange=function(){o.removeInteraction(e),r(n.value,o)},r(n.value,o)};return{init:a,drawInteraction:r,addDrawTypeSwitcher:l}}(),pickerModule=function(){var e,t=0,o=20,n=-2,a="place",r="en",l=function(r){r.on("click",function(l){var d=r.getView(),m=l.coordinate,p=d.getProjection(),g=d.getZoom();console.log("Zoom",g),console.log("zoomMin",t),console.log("zoomMax",o),console.log("zoomDelta",n),g=Math.min(Math.max(g+n,t),o),console.log("Extraction level",g),m=ol.proj.transform(m,p.getCode(),"EPSG:4326"),console.log("Picked",a);var f=$("#auto_insert_road");"road"!==a&&f&&f.is(":checked")&&roadbookModule.insertRoad(),e&&e.abort(),console.time("Reverse geocoding"),"place"===a?(e=i(m,g),e.done(function(e){"way"!==e.osm_type?roadbookModule.insertCity(e):console.log("osm_type is not the required type",e.osm_type)})):"road"===a?(e=s(m),e.done(function(e){if("way"===e.osm_type){u(e);var t=$("#auto_insert_road");t&&t.not(":checked")&&roadbookModule.insertRoad(e)}else console.log("osm_type is not the required type",e.osm_type)})):(e=c(m),e.done(function(e){"relation"!==e.osm_type?roadbookModule.insertPOI(e):console.log("osm_type is not the required type",e.osm_type)})),console.timeEnd("Reverse geocoding");var h=$("#default_type");if(h){var y=$("#pick_"+h.val());y&&y.trigger("click")}})},i=function(e,t){var o={format:"json",lon:e[0],lat:e[1],zoom:t,osm_type:"relation",addressdetails:1,extratags:1,namedetails:1,"accept-language":r},n=$("#map").find(".spinner");return n.fadeIn(),geocodeModule.nominatimReverse(o).always(function(){n.fadeOut()})},s=function(e){var t={format:"json",lon:e[0],lat:e[1],zoom:21,osm_type:"way",addressdetails:1,extratags:0,namedetails:1,"accept-language":r},o=$("#map").find(".spinner");return o.fadeIn(),geocodeModule.nominatimReverse(t).always(function(){o.fadeOut()})},c=function(e){var t={format:"json",lon:e[0],lat:e[1],zoom:21,osm_type:"node",addressdetails:1,extratags:1,namedetails:1,"accept-language":r},o=$("#map").find(".spinner");return o.fadeIn(),geocodeModule.nominatimReverse(t).always(function(){o.fadeOut()})},u=function(e){var t,o;e.address&&$.each(e.address,function(e,n){return o=e,t=n,!1}),e.namedetails&&(t=e.namedetails.ref||e.namedetails.int_ref||e.namedetails.name);var n=$("#road");if(t&&o&&n){if(n.is(":focus")){var a=document.getElementById(n.attr("id")).selectionStart,r=n.val();t=r.substring(0,a)+t+r.substring(a)}n.val(t),n.attr("data-nominatim-reverse",JSON.stringify(e))}};return $(function(){$("#zoom_delta").on("change",function(){n=parseInt($(this).val())}).trigger("change"),$("#zoom_max").on("change",function(){o=parseInt($(this).val())}).trigger("change"),$("#zoom_min").on("change",function(){t=parseInt($(this).val())}).trigger("change"),$("#user_language").on("change",function(){r=$(this).val()}).trigger("change");var e=$("#map").find(".spinner");e.hide();var l=$("#pick_place, #pick_road, #pick_poi");l.filter('[data-type="'+a+'"]').addClass("active"),l.click(function(){a=$(this).data("type"),console.log("Pick mode",a),l.removeClass("active"),$(this).addClass("active")});var i=$("#road");i.on("change",function(){i.val()||i.attr("data-nominatim-reverse",null)})}),{watchMapClick:l}}(),styleModule=function(){var e,t={style:{containerSelector:"#roadbook_style"},basil:{namespace:"roadbook_style_editor"},quill:{containerSelector:"#roadbook_style_editor",styles:!1,formats:[]}},o=new window.Basil(t.basil),n=function(t){e.getLength()?swal({title:"Replace styles ?",text:"The current styles will be overwritten.\nDo you really want to continue?",type:"warning",confirmButtonText:"Yes replace",cancelButtonText:"No stop !",showCancelButton:!0,buttonsStyling:!1,confirmButtonClass:"btn btn-warning",cancelButtonClass:"btn btn-warning"},function(o){o&&(e.setText(t),r())}):(e.setText(t),r())},a=function(){return e.getText()},r=function(){var n=e.getText();$(t.style.containerSelector).html(n),o.set("contents",e.getContents()),console.log("Style updated")},l=function(){e=new Quill(t.quill.containerSelector,t.quill),e.on("text-change",function(e,t){"user"===t&&r(),appModule.updateSaveLink()});var n=$(t.style.containerSelector).html();$(t.style.containerSelector).attr("data-default-value",n);var a=o.get("contents");a?(e.setContents(a),r()):e.setText(n),$("#reset_style").click(function(){n=$(t.style.containerSelector).data("default-value"),e.setText(n),r(),swal({title:"Done!",text:"Styles have been reset with the default values.",type:"success",timer:3e3,showConfirmButton:!1})})},i=function(){return e},s=function(){l()};return $(function(){}),{getEditor:i,init:s,getStyle:a,updateStyle:r,replaceTextAlert:n}}(),roadbookModule=function(){var e,t=" ",o={basil:{namespace:"roadbook"},quill:{styles:!1}};if("function"==typeof Basil)var n=new window.Basil(o.basil);var a=function(){var t=0;e.focus();var o=e.getSelection();return t=o?o.start:e.getLength()-1,console.log("getCaretPos",t),t},r=function(){e.focus();var t=e.getSelection();t&&t.start!==t.end&&(e.deleteText(t.start,t.end),console.log("Selection deleted from ",t.start+" to "+t.end))},l=function(o){var n,l={span:!0},i=[],s=[];if(!o)return!1;if(l.latitude=o.lat,l.longitude=o.lon,o.address&&$.each(o.address,function(e,t){return l.place=e,n=t,console.log("Smallest place",l.place),!1}),o.extratags&&(o.extratags.population&&(l.population=Math.log(o.extratags.population).toFixed(0)),o.extratags.capital&&(l.capital=o.extratags.capital),o.extratags.place&&(l.place=o.extratags.place)),o.namedetails&&o.namedetails.name){var c=$.map(o.namedetails.name.split("/"),$.trim);$.merge(i,c)}if(i.length>0){r();var u=a(),d="";d=$.unique(i).shift(),e.insertText(u,d,l,"user"),u+=d.length,n&&n!==d&&(d=t,e.insertText(u,d,!1,"user"),u+=t.length,d=n,e.insertText(u,d,{span:!0,type:"translation"},"user"),u+=d.length),s.length>0&&(d=t,e.insertText(u,d,!1,"user"),u+=t.length,d=" "+$.unique(s).join(", "),e.insertText(u,d,{"class":"details"},"user"),u+=d.length),e.insertText(u,t,!1,"user"),u+=t.length,e.setSelection(u,u,"user")}else console.log("Extracted data does not contain a city name.")},i=function(o){var n,l,i={span:!0,place:"road"},s=$("#road");if(!o&&s&&(n=s.val(),o=s.data("nominatim-reverse"),console.log("Restored road data",o)),o&&(i.latitude=o.lat,i.longitude=o.lon,o.address&&$.each(o.address,function(e,t){return i.place=e,l=t,console.log("Smallest place",i.place),!1}),o.namedetails&&(n=n||o.namedetails.ref||o.namedetails.int_ref||o.namedetails.name||l)),n){r();var c=a(),u="";u=n,e.insertText(c,u,i,"user"),c+=u.length,e.insertText(c,t,!1,"user"),c+=t.length,e.setSelection(c,c,"user")}},s=function(o){var n,l,i,s={span:!0};if(!o)return!1;if(s.latitude=o.lat,s.longitude=o.lon,o.address&&$.each(o.address,function(e,t){return s.place=e,l=t,i=e,"road"===e?(console.log("Place type refused",e),!1):(console.log("Smallest place",s.place),!1)}),o.address&&$.each(o.address,function(e,t){return s.place=e,l=t,console.log("Smallest place",s.place),!1}),o.namedetails&&o.namedetails.name&&(n=o.namedetails.name),n&&i){r();var c=a(),u="";u=n,e.insertText(c,u,s,"user"),c+=u.length,l&&l!==u&&(u=t,e.insertText(c,u,!1,"user"),c+=t.length,u=l,e.insertText(c,u,{span:!0,type:"translation"},"user"),c+=u.length),e.insertText(c,t,!1,"user"),c+=t.length,e.setSelection(c,c,"user")}else console.log("Extracted data does not contain a name.")},c=function(t){e.getLength()?swal({title:"Replace styles ?",text:"The current styles will be overwritten.\nDo you really want to continue?",type:"warning",confirmButtonText:"Yes replace",cancelButtonText:"No stop !",showCancelButton:!0,buttonsStyling:!1,confirmButtonClass:"btn btn-warning",cancelButtonClass:"btn btn-warning"},function(o){o&&e.setHTML(t)}):e.setHTML(t)},u=function(){var t=$('#save_roadbook, #copy_roadbook, #print_roadbook, #new_roadbook, #erase_roadbook, [data-target="#style_edition_modal"]'),o=e.getLength()>1;t.attr("disabled",!o).closest("li").toggleClass("disabled",!o)},d=function(){var e=appModule.buildExport();if(e){var t=window.open("",window.location.hostname,"");t.document.write(e),t.print(),t.close()}},m=function(){return e},p=function(){var t=$("#editor");if(e=new Quill("#editor",o.quill),$("#editor").find(".ql-editor").addClass("roadbook"),e.addModule("toolbar",{container:"#style_edition_modal"}),e.addFormat("span",{tag:"span"}),e.addFormat("type",{attribute:"data-type"}),e.addFormat("place",{attribute:"data-place"}),e.addFormat("population",{attribute:"data-population"}),e.addFormat("capital",{attribute:"data-capital"}),e.addFormat("placeType",{attribute:"data-place-type"}),e.addFormat("latitude",{attribute:"data-latitude"}),e.addFormat("longitude",{attribute:"data-longitude"}),e.addFormat("nominatimReverse",{attribute:"data-nominatim-reverse"}),e.on("text-change",function(){u(),appModule.updateSaveLink(),t.scrollTop(t[0].scrollHeight),$("#roadbook_editor_contents").html(JSON.stringify(e.getContents())),n&&n.set("roadbook_editor_contents",e.getContents())}),e.on("selection-change",function(e,t){var o=$("#editor_toolbar").find('[data-target="#style_edition_modal"], .ql-bold, .ql-italic, .ql-strike, .ql-underline, .ql-size, .ql-color, .ql-background');e?e.start===e.end?(o.attr("disabled",!0).closest("li").addClass("disabled"),console.log("Caret moved by "+t,e.start)):(o.attr("disabled",!1).closest("li").removeClass("disabled"),console.log("Text selected by "+t,e.start+" to "+e.end)):console.log("Editor lost focus")}),n){var a=n.get("roadbook_editor_contents");if(a){e.getSelection(),e.setContents(a),console.log("Roadbook content restored");var r=e.getLength()-1;e.setSelection(r,r,"user")}}},g=function(){u(),$("#print_roadbook").click(function(t){t.preventDefault(),d(e.getHTML())}),$("#insert_road").click(function(e){e.preventDefault(),i()}),$("#erase_roadbook, #new_roadbook").click(function(t){t.preventDefault(),swal({title:"Delete roadbook ?",text:"The current roadbook will be permanently removed.\nDo you really want to continue?",type:"warning",confirmButtonText:"Yes delete",cancelButtonText:"No cancel",showCancelButton:!0,closeOnConfirm:!1},function(t){t&&(e.deleteText(0,e.getLength()-1,"user"),swal({title:"Deleted!",text:"Your roadbook has been deleted.\nLet's start a new one!",type:"success",timer:3e3,showConfirmButton:!1}))})})},f=function(){p(),g()};return $(function(){var e=$("#style_edition_modal");e.find(".modal-footer .btn-primary").on("click",function(){e.modal("hide")})}),{getEditor:m,init:f,insertCity:l,insertRoad:i,insertPOI:s,replaceHtmlAlert:c}}(),htmlEditorModule=function(){var e,t=function(){return e},o=function(){var t=roadbookModule.getEditor();e.setText(t.getHTML()),e.on("text-change",function(o,n){"user"===n&&t.setHTML(e.getText())}),t.on("text-change",function(o,n){"user"===n&&e.setText(t.getHTML())})},n=function(){e=new Quill("#roadbook_editor_html",{}),o()};return{getEditor:t,init:n}}(),importModule=function(){var e=function(e){return $("<div>").append(e).find(".roadbook").html()},t=function(e){return $("<div>").append(e).find("style").html()},o=function(o){commonsModule.reader(o,function(o){swal({title:"Are you sure?",text:"Current roadbook and / or style will be replaced.\nDo you really want to continue?",type:"warning",showCancelButton:!0,confirmButtonText:"Yes replace",cancelButtonText:"No cancel",closeOnConfirm:!1},function(n){if(n){if($("#import_html").is(":checked")){var a=e(o),r=roadbookModule.getEditor();r.setHTML(a)}if($("#import_style").is(":checked")){var l=t(o),i=styleModule.getEditor();i.setText(l),styleModule.updateStyle()}swal({title:"Imported!",text:"Your file has been imported.\nLet's start editing!",type:"success",timer:3e3,showConfirmButton:!1})}})})},n=function(){$("#import_form").on("submit",function(e){e.preventDefault(),$("#import_modal").modal("hide");var t=document.getElementById("html_file").files;o(t)})};return $(function(){}),{init:n}}(),geocodeModule=function(){var e=function(e,t){var o="http://nominatim.openstreetmap.org/search/"+encodeURI(t)+"?"+$.param(e);return console.log(o),$.ajax({url:o,error:function(e,t,o){console.warn(t,o)}})},t=function(e){console.time("Nominatim reverse geocoding complete");var t="http://nominatim.openstreetmap.org/reverse?"+$.param(e);return console.log("Nominatim reverse geocoding request",t),$.ajax({url:t}).done(function(e){console.log("Nominatim reverse geocoding result",JSON.stringify(e))}).fail(function(){console.warn("Nominatim reverse geocoding failed")}).always(function(){console.timeEnd("Nominatim reverse geocoding complete")})};return{nominatimSearch:e,nominatimReverse:t}}(),appModule=function(){var e;commonsModule.debug(),commonsModule.loadWebFonts(),swal.setDefaults({buttonsStyling:!1,confirmButtonClass:"btn btn-primary",cancelButtonClass:"btn btn-default"});var t=mapLayersModule.create("openCycleMap"),o=mapLayersModule.create("openStreetMap",{visible:!0}),n=mapLayersModule.create("mapsForFreeRelief"),a=mapLayersModule.create("customBaseLayer",{title:'Custom tile server <a href="#layer_settings_modal" data-toggle="modal" data-target-section="1"><span class="glyphicon glyphicon-cog"></span></a>'}),r=mapLayersModule.create("googleMap"),l=mapLayersModule.create("googleTerrain"),i=mapLayersModule.create("googleSatellite"),s=mapLayersModule.create("lonviaHiking"),c=mapLayersModule.create("lonviaCycling"),u=mapLayersModule.create("gpxFile",{title:'GPS tracks <a href="#gpx_reader_modal" data-toggle="modal"><span class="glyphicon glyphicon-cog"></span></a>'}),d=mapLayersModule.create("customOverlay",{title:'Custom tile server <a href="#layer_settings_modal" data-toggle="modal" data-target-section="2"><span class="glyphicon glyphicon-cog"></span></a>'}),m=mapLayersModule.create("googleBike"),p=mapLayersModule.create("googleHybrid"),g=mapControlsModule.create("attribution"),f=mapControlsModule.create("scaleLine"),h=mapControlsModule.create("fullScreen"),y=mapControlsModule.create("layerSwitcher"),w=mapControlsModule.create("zoomSlider"),b=!!parseInt($.urlParam("godfather"));console.log("Godfather mode",b);var v=function(){var e={url:document.URL,title:"I'm doing a tiny roadbook for my next tour"},t=roadbookModule.getEditor();t.on("text-change",function(){var o=t.getText();$.extend(e,{description:o.substring(0,100)+(o.length>100?"...":"")})})},S=function(){var e="",t=roadbookModule.getEditor(),o=styleModule.getEditor();return t&&o&&(e="<html>\n<head>\n<title>"+window.location.hostname+'</title>\n<meta charset="UTF-8">\n<style>\n'+o.getText()+'\n</style>\n</head>\n<body>\n<div class="roadbook">\n'+t.getHTML()+"\n</div>\n</body>\n</html>"),e},M=function(){var e=S();e&&$("#save_roadbook").attr("href","data:text/html;base64, "+Base64.encode(e))},T=function(e){var v;v=b?[new ol.layer.Group({name:"baseLayers",title:"Base map",layers:[a,i,l,n,t,r,o]}),new ol.layer.Group({name:"overlays",title:"Overlays",layers:[d,s,m,c,p,u]})]:[new ol.layer.Group({name:"baseLayers",title:"Base map",layers:[a,n,t,o]}),new ol.layer.Group({name:"overlays",title:"Overlays",layers:[d,s,c,u]})];var S=ol.control.defaults({attribution:!1,attributionOptions:{collapsible:!1},zoomOptions:{}}).extend([g,f,h,y,w]);return new ol.Map({layers:v,target:e,view:new ol.View({center:[0,0],zoom:4,minZoom:2,maxZoom:19}),controls:S})};return $(function(){console.time("Bootstrap module initialized"),bootstrapModule.debug(),bootstrapModule.restoreActiveTab(),bootstrapModule.tab(),bootstrapModule.modalTogglerAttributs(),bootstrapModule.tooltip(),console.timeEnd("Bootstrap module initialized"),commonsModule.disableUnsupported(),commonsModule.adsense(),commonsModule.hideHashOnClick(),roadbookModule.init(),htmlEditorModule.init(),styleModule.init(),importModule.init(),v();var t=$("#user_language");t&&(t.val(navigator.language||navigator.userLanguage),console.log("User language defined",t.val())),commonsModule.fixInputValues(),commonsModule.storeForms();var o=$('a[data-toggle="tab"]');o.filter('[href="#home_pane"]').one("shown.bs.tab",function(){commonsModule.parallax()}),o.filter('[href="#editor_pane"]').one("shown.bs.tab",function(){return e?!1:(e=new MapModule(T("map")),console.log("Map initialized"),e.debug(),e.restoreMapState()||(e.setCenterOnPosition(),e.map.getView().setZoom(12)),e.storeMapState(),pickerModule.watchMapClick(e.map),$("#gpx_file").on("change",function(e){var t=e.target.files;bootstrapModule.inputFileList(t,"#gpx_file_list")}),$("#gpx_reader_form").on("submit",function(e){e.preventDefault(),$("#gpx_reader_modal").modal("hide");var t=document.getElementById("gpx_file").files,o=$("#map").find(".spinner");o.fadeIn(),u.getSource().clear();var n=commonsModule.reader(t,function(e){var t=new ol.format.GPX,o=t.readFeatures(e,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"});u.getSource().addFeatures(o),u.setProperties({visible:!0})});n.done(function(){o.fadeOut()}),y.renderPanel()}),void $(".layer-switcher").on("click",'a[data-toggle="modal"]',function(){$(this).trigger("click.bs.modal.data-api")}))}),o.filter('[href="#settings_pane"]').one("shown.bs.tab",function(){commonsModule.resetButton(),bootstrapModule.rangeValueTooltip()}),o.filter('[href="#style_pane"]').one("shown.bs.tab",function(){}),$("#reset_settings").click(function(){commonsModule.resetInputValues()}),$("#layer_settings_form").on("submit",function(e){e.preventDefault(),$("#layer_settings_modal").modal("hide")}),mapLayersModule.inputLayerSource(a,"#base_layer_tile_server"),mapLayersModule.inputLayerSource(d,"#overlay_tile_server")}),{buildExport:S,updateSaveLink:M}}();